<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign in | BlackRose</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #050505;
      color: #f8f8f8;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      padding: 32px;
    }
    .shell {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      text-align: center;
    }
    .card {
      width: 100%;
      background: #0d0d0f;
      border: 1px solid #1c1c20;
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .logo-img {
      height: 90px;
      object-fit: contain;
      margin-bottom: 10px;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
    }
    .subtitle {
      color: #c7c7c7;
      margin-bottom: 22px;
      line-height: 1.5;
      font-size: 14px;
    }
    .section-title {
      font-weight: 700;
      margin: 12px 0 8px;
      font-size: 15px;
      color: #f5c542;
      letter-spacing: 0.2px;
    }
    .section-subtitle {
      color: #9b9b9b;
      font-size: 13px;
      margin-bottom: 16px;
    }
    .btn {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid #f5c542;
      cursor: pointer;
      background: linear-gradient(135deg, #f8d255, #f5c542);
      color: #1a1a1a;
      font-weight: 700;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform .08s ease, box-shadow .12s ease, background .15s ease;
    }
    .btn:hover {
      background: linear-gradient(135deg, #ffd669, #f4b400);
      box-shadow: 0 12px 30px rgba(245, 197, 66, .35);
      transform: translateY(-1px);
    }
    .btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .divider {
      height: 1px;
      width: 100%;
      background: #1c1c20;
      margin: 16px 0 12px;
    }
    .features {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px 16px;
      margin-top: 8px;
      color: #d6d6d6;
      font-size: 13px;
    }
    .feature {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      line-height: 1.3;
      color: #cfcfcf;
    }
    .feature .icon {
      font-size: 18px;
      color: #f5c542;
    }
    .hint {
      margin-top: 6px;
      font-size: 12px;
      color: #9b9b9b;
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }
    .hint .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      border: 1px solid #f5c542;
    }
    .status {
      margin-top: 10px;
      min-height: 20px;
      font-size: 13px;
      color: #a1a1aa;
    }
  </style>
</head>
<body>
  <div class="shell">
    <img src="/images/logo_blackrose.png" alt="BlackRose" class="logo-img" onerror="this.onerror=null; this.src='logo_blackrose.png';">
    <div class="subtitle">Ch√†o m·ª´ng tr·ªü l·∫°i<br>ƒêƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p b·∫£ng ƒëi·ªÅu khi·ªÉn giao d·ªãch chuy√™n nghi·ªáp</div>
    <div class="card">
      <div class="section-title">Ti·∫øp t·ª•c b·∫±ng Telegram</div>
      <div class="section-subtitle">X√°c th·ª±c an to√†n ch·ªâ d√†nh cho th√†nh vi√™n ƒë√£ ƒë∆∞·ª£c x√°c minh</div>
      <button id="tg-login" class="btn" type="button">ƒêƒÉng nh·∫≠p b·∫±ng Telegram</button>
      <div id="status" class="status"></div>
      <div class="divider"></div>
      <div class="section-title" style="margin-top: 8px;">T√çNH NƒÇNG N·ªÄN T·∫¢NG</div>
      <div class="features">
        <div class="feature"><span class="icon">üìà</span><span>D·ªØ li·ªáu th·ªùi gian th·ª±c</span></div>
        <div class="feature"><span class="icon">üîí</span><span>Truy c·∫≠p an to√†n</span></div>
        <div class="feature"><span class="icon">üë•</span><span>C·ªông ƒë·ªìng</span></div>
        <div class="feature"><span class="icon">‚ö°</span><span>C·∫£nh b√°o</span></div>
      </div>
    </div>
    <div class="hint">
      <span class="dot"></span>
      <span>Truy c·∫≠p h·∫°n ch·∫ø ¬∑ Ch·ªâ d√†nh cho th√†nh vi√™n ƒë∆∞·ª£c ·ªßy quy·ªÅn</span>
    </div>
  </div>

  <script>
    window.__TG_CONFIG__ = { botUsername: '', botId: '' };

    let telegramReadyPromise;
    let telegramReady = false;
    function loadTelegramSDK() {
      if (window.Telegram && Telegram.Login) return Promise.resolve();
      if (!telegramReadyPromise) {
        telegramReadyPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://telegram.org/js/telegram-widget.js?22';
          script.async = true;
          script.onload = () => {
            const waitForApi = () => {
              if (window.Telegram && Telegram.Login) {
                resolve();
              } else {
                setTimeout(waitForApi, 50);
              }
            };
            waitForApi();
          };
          script.onerror = () => reject(new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c SDK Telegram'));
          document.head.appendChild(script);
        });
      }
      return telegramReadyPromise;
    }

    async function handleTelegramLogin() {
      if (!window.__TG_CONFIG__.botId) {
        setStatus('Thi·∫øu c·∫•u h√¨nh Telegram bot.', true);
        return;
      }
      if (!telegramReady) {
        setStatus('ƒêang t·∫£i Telegram, vui l√≤ng th·ª≠ l·∫°i sau gi√¢y l√°t...', false);
        return;
      }
      setStatus('ƒêang m·ªü Telegram...', false);
      try {
        Telegram.Login.auth({
          bot_id: Number(window.__TG_CONFIG__.botId),
          request_access: 'write'
        }, onTelegramAuth);
      } catch (err) {
        console.error(err);
        setStatus('Kh√¥ng th·ªÉ k·∫øt n·ªëi Telegram. Ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c t·∫Øt ch·∫∑n pop-up.', true);
      }
    }

    async function onTelegramAuth(user) {
      setStatus('ƒêang x√°c th·ª±c...', false);
      try {
        const res = await fetch('/api/auth/telegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ authData: user })
        });
        if (res.ok) {
          setStatus('Th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...', false);
          // Redirect or display dashboard.
          window.location.href = '/dashboard';
        } else {
          const msg = (await res.json()).error || 'B·∫°n c·∫ßn l√† th√†nh vi√™n c·ªßa nh√≥m ƒë·ªÉ ƒëƒÉng nh·∫≠p.';
          setStatus(msg, true);
        }
      } catch (err) {
        console.error(err);
        setStatus('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', true);
      }
    }

    function setStatus(message, isError) {
      const el = document.getElementById('status');
      el.textContent = message;
      el.style.color = isError ? '#f87171' : '#a1a1aa';
    }

    window.addEventListener('DOMContentLoaded', () => {
      const button = document.getElementById('tg-login');
      button.disabled = true;
      // N·∫øu ƒë√£ c√≥ phi√™n, chuy·ªÉn th·∫≥ng v√†o dashboard
      fetch('/api/me')
        .then((res) => res.ok ? res.json() : null)
        .then((data) => {
          if (data?.user) {
            window.location.href = '/dashboard';
          }
        })
        .catch(() => {});

      Promise.all([
        fetch('/api/config')
          .then((res) => res.json())
          .then((data) => {
            window.__TG_CONFIG__ = {
              botUsername: data.botUsername || '',
              botId: data.botId || ''
            };
            if (!data.botId || !data.botUsername) {
              throw new Error('Thi·∫øu th√¥ng tin bot tr√™n server');
            }
          }),
        loadTelegramSDK()
      ])
        .then(() => {
          telegramReady = true;
          button.disabled = false;
          setStatus('');
        })
        .catch((err) => {
          console.error(err);
          setStatus('Kh√¥ng t·∫£i ƒë∆∞·ª£c c·∫•u h√¨nh/SDK Telegram. Ki·ªÉm tra server ho·∫∑c k·∫øt n·ªëi m·∫°ng.', true);
        });
    });
    document.getElementById('tg-login').addEventListener('click', handleTelegramLogin);
  </script>
</body>
</html>
